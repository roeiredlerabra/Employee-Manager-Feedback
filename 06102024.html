<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>סיכום משוב הדדי</title>
    <link rel="stylesheet" href="new_style.css?v=1.0">
    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for radar charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Your existing CSS -->
    <style>

    </style>
</head>

<body>
    <!-- Header -->
    <header class="page-header">
        <div class="header-content">
            <img src="https://raw.githubusercontent.com/roeiredlerabra/abra-on-boarding/main/img/_master_logo_%D7%90%D7%91%D7%A8%D7%90%20%D7%91%D7%9C%D7%91%D7%9F.gif"
                alt="Company Logo" class="header-logo">
            <div>
                <h1 class="text-2xl font-bold">סיכום משוב הדדי</h1>
                <div class="text-sm opacity-90">תקופת הערכה: <span id="evaluationPeriod"></span></div>
            </div>
        </div>
    </header>
    <!-- Login Overlay -->
    <div id="loginOverlay">
        <div class="login-container">
            <img src="https://raw.githubusercontent.com/roeiredlerabra/abra-on-boarding/main/img/_master_logo_%D7%90%D7%91%D7%A8%D7%90%20%D7%91%D7%9C%D7%91%D7%9F.gif" alt="Company Logo">
            <div class="mb-3">
                <input type="password" id="passwordInput" class="form-control text-center" placeholder="הזן סיסמה" aria-label="Password">
            </div>
            <button id="checkPasswordBtn" class="btn btn-primary">
                בדוק הרשאה
            </button>
        </div>
    </div>
    <!-- Main Content -->
    <main class="main-container">
        <!-- Employee Info Section -->
        <div class="comparison-wrapper">
            <div class="employee-info-header">
                <div class="employee-info-grid">
                    <!-- Employee Section -->
                    <div class="info-section">
                        <!-- Skeleton Employee Info -->


                        <!-- Real Employee Info -->
                        <div class="real-content">
                            <h3 class="info-section-title">
                                <i class="fas fa-user"></i> פרטי עובד
                            </h3>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-user-tag"></i> שם העובד/ת</span>
                                <span class="info-value" id="employeeName"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-briefcase"></i> מחלקה</span>
                                <span class="info-value" id="employeeDepartment"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-envelope"></i> דואר אלקטרוני</span>
                                <span class="info-value" id="employeeEmail"></span>
                            </div>
                            <div class="info-row">
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-calendar-day"></i> תאריך תחילת
                                        עבודה</span>
                                    <span class="info-value" id="employeeHireDate"></span>
                                    <span class="info-value" id="employeeTenure"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Manager Section -->
                    <div class="info-section">
                        <!-- Skeleton Manager Info -->


                        <!-- Real Manager Info -->
                        <div class="real-content">
                            <h3 class="info-section-title">
                                <i class="fas fa-users-cog"></i> פרטי מנהל
                            </h3>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-user-tie"></i> שם המנהל/ת</span>
                                <span class="info-value" id="managerName"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-briefcase"></i> מחלקה</span>
                                <span class="info-value" id="managerDepartment"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-envelope"></i> דואר אלקטרוני</span>
                                <span class="info-value" id="managerEmail"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey Comparison Content -->
            <div id="surveyContent">
                <!-- Dynamic content will be inserted here -->
            </div>

            <!-- Summary Section -->
            <div id="summarySection" class="category-section">
                <h2 class="category-title">סיכום והערות</h2>
                <div class="mb-4">
                    <textarea id="summaryNotes" class="w-full p-4 min-h-[200px] border rounded-lg"
                        placeholder="הזן כאן את הערות הסיכום..."></textarea>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="footer-content">
            <div>
                <div class="text-sm opacity-75">תאריך מילוי</div>
                <div id="submissionDate"></div>
            </div>
            <button id="downloadExcel" class="btn btn-success">
                <i class="fas fa-file-excel"></i> הורד לאקסל
            </button>
            <button type="button" id="submitButton" class="submit-btn">
                <span class="submit-text">שלח סיכום</span>
                <span class="loading-spinner2 hidden"></span>
            </button>
        </div>
    </footer>

    <script>
        // Constants
        const API_ENDPOINT = 'https://prod-39.westeurope.logic.azure.com:443/workflows/37fef182446d4610b731450f081f43fc/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2zKGo49JL0waedwDDLfiCsk5S1p4-KMDvehVNazN_DA';

        // Categories configuration (copy your existing categories object)
        async function checkPassword() {
    showLoading();
    const password = document.getElementById('passwordInput').value;
    const urlParams = new URLSearchParams(window.location.search);
    const param = urlParams.get('param');
    const surveyId = new URLSearchParams(window.location.search).get('param').split('-')[0];

    try {
        const response = await fetch(API_ENDPOINT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: "password_check",
                surveyId: surveyId,
                password: password
            })
        });

        if (response.ok) {
            hideLoading();
            document.getElementById('loginOverlay').style.display = 'none';
            document.querySelector('.main-container').style.display = 'block';
            document.querySelector('.page-header').style.display = 'block';
            document.querySelector('.page-footer').style.display = 'block';
            initializeComparison();
            showAlert('התחברות בוצעה בהצלחה', 'success');
        } else {
            hideLoading();
            showAlert('סיסמה שגויה', 'error');
        }
    } catch (error) {
        hideLoading();
        showAlert('אירעה שגיאה בבדיקת ההרשאה', 'error');
    }
}

           
const categories = {
            "ידע מקצועי": [
                {
                    "M_question": "עד כמה העובד.ת מבין.ה לעומק את המוצר, כולל רכיבים טכניים ותפעוליים?",
                    "E_question": "עד כמה את.ה מבין.ה לעומק את המוצר, כולל רכיבים טכניים ותפעוליים?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "product_knowledge",
                    "required": true,
                    "ariaLabel": "דירוג בקיאות במוצר",
                    "description": "הערכת רמת ההבנה והידע במוצר ורכיביו"
                },
                {
                    "M_question": "באיזו מידה העובד.ת מיישם.ת את שיטות העבודה המתודולוגיות בפרויקטים השונים?",
                    "E_question": "באיזו מידה את.ה מיישם.ת את שיטות העבודה המתודולוגיות בפרויקטים השונים?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "methodology_knowledge",
                    "required": true,
                    "ariaLabel": "דירוג הכרות עם מתודולוגיות",
                    "description": "הערכת יישום שיטות העבודה בפרויקטים"
                },
                {
                    "M_question": "עד כמה העובד.ת מבין.ה את הצרכים העסקיים של הלקוחות ומתאים את הפתרונות בהתאם?",
                    "E_question": "עד כמה את.ה מבין.ה את הצרכים העסקיים של הלקוחות ומתאים.ה את הפתרונות בהתאם?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "client_environment_knowledge",
                    "required": true,
                    "ariaLabel": "דירוג הכרות עם סביבת לקוחות",
                    "description": "הערכת הבנת צרכי הלקוח והתאמת פתרונות"
                },
                {
                    "M_question": "עד כמה העובד.ת מזהה אפשרויות להרחבת פתרונות ושירותים קיימים?",
                    "E_question": "עד כמה את.ה מזהה אפשרויות להרחבת פתרונות ושירותים קיימים?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "client_opportunities",
                    "required": true,
                    "ariaLabel": "דירוג זיהוי הזדמנויות",
                    "description": "הערכת יכולת זיהוי הזדמנויות עסקיות"
                },
                {
                    "M_question": "עד כמה העובד.ת מכיר.ה מוצרים רלוונטיים נוספים שיכולים להשתלב עם הפרויקטים של מיקרוסופט?",
                    "E_question": "עד כמה את.ה מכיר.ה מוצרים רלוונטיים נוספים שיכולים להשתלב עם הפרויקטים של מיקרוסופט?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "complementary_products",
                    "required": true,
                    "ariaLabel": "דירוג הכרות עם מוצרים משלימים",
                    "description": "הערכת ידע במוצרים משלימים ורלוונטיים"
                }
            ],
            "מיומנויות עבודה": [
                {
                    "M_question": "עד כמה העובד.ת מצליח.ה לעבוד בצורה עצמאית תוך ייזום פתרונות, או זקוק.ה להכוונה מתמדת?",
                    "E_question": "עד כמה את.ה מצליח.ה לעבוד בצורה עצמאית תוך ייזום פתרונות, או זקוק.ה להכוונה מתמדת?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "self_management",
                    "required": true,
                    "ariaLabel": "דירוג יכולת ניהול עצמי",
                    "description": "הערכת יכולת עבודה עצמאית וייזום"
                },
                {
                    "M_question": "באיזו מידה מצליח.ה העובד.ת להתתמודד עם משימות דחופות או תחת עומס?",
                    "E_question": "באיזו מידה את.ה מתמודד.ת עם משימות דחופות או תחת עומס?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "pressure_handling",
                    "required": true,
                    "ariaLabel": "דירוג עבודה תחת לחץ",
                    "description": "הערכת התמודדות עם מצבי לחץ ועומס"
                },
                {
                    "M_question": "עד כמה העובד.ת לוקח.ת אחריות מלאה על המשימות שלו.ה, כולל תיקון טעויות ושיפור?",
                    "E_question": "עד כמה את.ה לוקח.ת אחריות מלאה על המשימות שלך, כולל תיקון טעויות ושיפור?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "professional_responsibility",
                    "required": true,
                    "ariaLabel": "דירוג אחריות מקצועית",
                    "description": "הערכת רמת האחריות והמחויבות למשימות"
                },
                {
                    "M_question": "באיזו מידה העובד.ת משתף.ת פעולה ומכבד.ת דעות שונות בצוות?",
                    "E_question": "באיזו מידה את.ה משתף.ת פעולה ומכבד.ת דעות שונות בצוות?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "team_collaboration",
                    "required": true,
                    "ariaLabel": "דירוג שיתוף פעולה",
                    "description": "הערכת יכולת עבודה בצוות ושיתוף פעולה"
                },
                {
                    "M_question": "באיזו מידה מצליח.ה העובד.ת לנהל תקשורת אפקטיבית עם ממשקי העבודה?",
                    "E_question": "באיזו מידה את.ה מנהל.ת תקשורת אפקטיבית עם ממשקי עבודה?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "effective_communication",
                    "required": true,
                    "ariaLabel": "דירוג תקשורת אפקטיבית",
                    "description": "הערכת יכולת תקשורת עם צוותים שונים"
                }
            ],
            "גישה ומוטיבציה": [
                {
                    "M_question": "עד כמה העובד.ת תורם.ת לאווירה החברתית והמקצועית בצוות או בחטיבה?",
                    "E_question": "עד כמה את.ה תורם.ת לאווירה החברתית והמקצועית בצוות או בחטיבה?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "social_involvement",
                    "required": true,
                    "ariaLabel": "דירוג מעורבות חברתית",
                    "description": "הערכת תרומה לאווירה החברתית בצוות"
                },
                {
                    "M_question": "כיצד העובד.ת מתמודד עם ביקורות ומשובים?",
                    "E_question": "באיזו מידה את.ה מתמודד.ת עם קבלת ביקורת בונה ומשובים?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "feedback_reception",
                    "required": true,
                    "ariaLabel": "דירוג קבלת ביקורת",
                    "description": "הערכת התמודדות עם משוב וביקורת"
                },
                {
                    "M_question": "באיזו מידה לתחושתך העובד.ת מעלה רעיונות חדשים או יוזמות?",
                    "E_question": "עד כמה לתחושתך את.ה מעלה רעיונות חדשים או יוזמות ?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "improvement_motivation",
                    "required": true,
                    "ariaLabel": "דירוג מוטיבציה לשיפור",
                    "description": "הערכת יוזמה לשיפור תהליכים"
                },
                {
                    "M_question": "עד כמה העובד.ת לומד.ת לבד ומשכלל את הידע המקצועי שלו?",
                    "E_question": "עד כמה את.ה לומד.ת לבד ומשכלל את הידע המקצועי שלך?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "self_learning",
                    "required": true,
                    "ariaLabel": "דירוג למידה עצמאית",
                    "description": "הערכת יוזמה ללמידה והתפתחות עצמאית"
                }
            ],
            "סגנון עבודה": [
                {
                    "M_question": "עד כמה העובד.ת שומר.ת על סביבת עבודה מאורגנת ומסודרת, תוך ניהול זמן ומשימות באופן יעיל?",
                    "E_question": "עד כמה את.ה שומר.ת על סביבת עבודה מאורגנת ומסודרת, תוך ניהול זמן ומשימות באופן יעיל?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "work_organization",
                    "required": true,
                    "ariaLabel": "דירוג סדר וארגון",
                    "description": "הערכת ארגון וסדר בסביבת העבודה"
                },
                {
                    "M_question": " באיזו מידה העובד.ת מקפיד.ה על ניהול זמן וביצוע משימות באופן יעיל?",
                    "E_question": " באיזו מידה את.ה מקפיד.ה על ניהול זמן וביצוע משימות באופן יעיל?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "time_management",
                    "required": true,
                    "ariaLabel": "דירוג עמידה בזמנים",
                    "description": "הערכת עמידה בלוחות זמנים"
                },
                {
                    "M_question": "באיזו מידה העובד.ת מצליח.ה לנהל פרויקטים תוך שמירה על יעדים ברורים ותוצרים איכותיים?",
                    "E_question": "באיזו מידה את.ה מצליח.ה לנהל פרויקטים תוך שמירה על יעדים ברורים ותוצרים איכותיים?",
                    "type": "rating",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "project_management",
                    "required": true,
                    "ariaLabel": "דירוג ניהול פרויקטים",
                    "description": "הערכת יכולת ניהול פרויקטים ועמידה ביעדים"
                }
            ],
            "הערכה מסכמת": [
                {
                    "M_question": "מהם ההישגים המרכזיים שהעובד.ת השיג.ה בתקופה האחרונה? תן דוגמאות.",
                    "E_question": "מהם ההישגים המרכזיים שהשגת בתקופה האחרונה? תן דוגמאות.",
                    "type": "text",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "key_achievements",
                    "required": true,
                    "ariaLabel": "הישגים בולטים",
                    "description": "פירוט הישגים משמעותיים בתקופה האחרונה"
                },
                {
                    "M_question": "אילו תחומים אצל העובד.ת את.ה מזהה שבהם יוכל.תוכל להשתפר? מה צריך.ה לעשות כדי להגיע לשם? תן דוגמאות.",
                    "E_question": "אילו תחומים את.ה מזהה שבהם תוכל.י להשתפר? מה תעשה.י כדי להגיע לשם? תן דוגמאות.",
                    "type": "text",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "improvement_areas",
                    "required": true,
                    "ariaLabel": "תחומים לשיפור",
                    "description": "פירוט תחומים הדורשים שיפור"
                },

                {
                    "M_question": "פוקוס לשנה הבאה- על מה תשמח.י לראות את העובד.ת מתמקד.ת בשנה הקרובה בהיבטים מקצועיים ובינאישיים?",
                    "E_question": "פוקוס לשנה הבאה- על מה את.ה מתכנן.ת להתמקד בשנה הקרובה בהיבטים מקצועיים ובינאישיים?",
                    "type": "text",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "future_goals",
                    "required": true,
                    "ariaLabel": "יעדים לתקופה הבאה",
                    "description": "הגדרת יעדים לתקופה הבאה"
                },
                {
                    "M_question": "האם יש הערות או תובנות נוספות שברצונך לשתף?",
                    "E_question": "האם יש הערות או תובנות נוספות שברצונך לשתף?",
                    "type": "text",
                    "roles": [
                        0,
                        1
                    ],
                    "schema": "additional_comments",
                    "required": false,
                    "ariaLabel": "הערות נוספות",
                    "description": "מקום להערות ותובנות נוספות"
                }
            ],
            "מיומנויות ניהוליות": [
                {
                    "M_question": "כמנהל.ת פרויקטים או צוות, עד כמה העובד.ת מקבל.ת החלטות במהירות ובביטחון, תוך הערכה נכונה של המצב?",
                    "E_question": "כמנהל.ת פרויקטים או צוות, עד כמה את.ה מקבל.ת החלטות במהירות ובביטחון, תוך הערכה נכונה של המצב?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "decision_making",
                    "required": true,
                    "ariaLabel": "דירוג קבלת החלטות",
                    "description": "הערכת יכולת קבלת החלטות מהירה ומדויקת"
                },
                {
                    "M_question": "באיזו מידה העובד.ת מצליח.ה לדאוג לניהול זמן או משימות אפקטיבי של הצוות, תוך הקפדה עלל סדר עדיפויות ברור? ",
                    "E_question": "באיזו מידה את.ה מצליח.ה לדאוג לניהול זמן או משימות אפקטיבי של הצוות, תוך הקפדה עלל סדר עדיפויות ברור?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "time_priority_management",
                    "required": true,
                    "ariaLabel": "דירוג ניהול זמן וסדרי עדיפויות",
                    "description": "הערכת יכולת ניהול זמן ותעדוף משימות"
                },
                {
                    "M_question": "באיזו מידה העובד.ת מצליח.ה להסתגל ולהתמודד עם שינויים בפרויקטים או בסדרי העדיפויות, תוך הובלת הצוות בהתאם?",
                    "E_question": "באיזו מידה את.ה מצליח.ה להסתגל ולהתמודד עם שינויים בפרויקטים או בסדרי העדיפויות, תוך הובלת הצוות בהתאם?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "change_adaptation",
                    "required": true,
                    "ariaLabel": "דירוג גמישות והסתגלות",
                    "description": "הערכת יכולת הסתגלות לשינויים"
                },
                {
                    "M_question": "באיזו מידה העובד.ת כמנהל.ת פרויקט או צוות, מציב.ה לעובדיו יעדים ברורים, מדידים וברי השגה?",
                    "E_question": "באיזו מידה את.ה כמנהל.ת פרויקט או צוות, מציב.ה לעובדיו יעדים ברורים, מדידים וברי השגה?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "goal_setting",
                    "required": true,
                    "ariaLabel": "דירוג הצבת יעדים",
                    "description": "הערכת יכולת הגדרת יעדים ברורים לצוות"
                },
                {
                    "M_question": "באיזו מידה העובד.ת מצליח.ה לגרום לעובדים.ות לבצע את משימותיהם בצורה הטובה ביותר?",
                    "E_question": "באיזו מידה את.ה כמנהל.ת מצליח.ה לגרום לעובדים.ות לבצע את משימותיהם בצורה הטובה ביותר?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "team_motivation",
                    "required": true,
                    "ariaLabel": "דירוג הנעת עובדים",
                    "description": "הערכת יכולת הנעת העובדים להשגת ביצועים מיטביים"
                },
                {
                    "M_question": "באיזו מידה העובד.ת כמנהל.ת פרויקט או צוות, מצליח.ה לקדם את עובדיו, לפתח אותם מקצועית ואישית?",
                    "E_question": "באיזו מידה אתה כמנהל.ת פרויקט או צוות, מצליח.ה לקדם את עובדיך, לפתח אותם מקצועית ואישית?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "employee_development",
                    "required": true,
                    "ariaLabel": "דירוג פיתוח עובדים",
                    "description": "הערכת יכולת פיתוח וקידום הצוות"
                },
                {
                    "M_question": "עד כמה העובד.ת מצליח.ה ללמוד מהצלחות ואי-הצלחות, תוך יישום הלקחים לצורך שיפור ביצועים עתידיים? ",
                    "E_question": "עד כמה את.ה מצליח.ה ללמוד מהצלחות ואי-הצלחות, תוך יישום הלקחים לצורך שיפור ביצועים עתידיים?",
                    "type": "rating",
                    "roles": [
                        1
                    ],
                    "schema": "lessons_learned",
                    "required": true,
                    "ariaLabel": "דירוג למידה מלקחים",
                    "description": "הערכת יכולת הפקת לקחים ויישומם"
                }
            ]
        };
              

        // Helper Functions
        const createElement = (tag, attributes = {}) => {
            const element = document.createElement(tag);
            Object.entries(attributes).forEach(([key, value]) => {
                if (key === 'className') {
                    element.className = value;
                } else if (key === 'innerHTML') {
                    element.innerHTML = value;
                } else {
                    element.setAttribute(key, value);
                }
            });
            return element;
        };
        const showAlert = (message, type = 'info') => {
    // Remove any existing alerts
    const existingAlert = document.querySelector('.custom-alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    // Create new alert
    const alert = document.createElement('div');
    alert.className = `custom-alert ${type}`;
    alert.innerHTML = `
        <span>${message}</span>
        <span class="close-btn" onclick="this.parentElement.remove()">&times;</span>
    `;
    document.body.appendChild(alert);

    // Auto remove after 5 seconds
    setTimeout(() => {
        if (alert && alert.parentElement) {
            alert.remove();
        }
    }, 5000);
};

// Loading overlay helper functions
const showLoading = () => {
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay2';
    overlay.innerHTML = '<div class="loading-spinner2"></div>';
    document.body.appendChild(overlay);
};

const hideLoading = () => {
    const overlay = document.querySelector('.loading-overlay2');
    if (overlay) {
        overlay.remove();
    }
};
        const transformApiData = (data) => {
            const employee = {};
            const manager = {};

            Object.keys(data).forEach(key => {
                if (key.startsWith('E_x002d_')) {
                    const cleanKey = key.replace('E_x002d_', '');
                    employee[cleanKey] = data[key];
                } else if (key.startsWith('M_x002d_')) {
                    const cleanKey = key.replace('M_x002d_', '');
                    manager[cleanKey] = data[key];
                }
            });

            return { employee, manager };
        };

        const RATING_SCALE = {
            4: 'מצטיין',
            3: 'מעל לנדרש',
            2: 'עבודה ע"פ הנדרש',
            1: 'נדרש שיפור',
            0: 'לא רלוונטי לתפקיד'
        };
        const generateExcel = () => {
    // Create a new workbook
    const wb = XLSX.utils.book_new();
    const allData = [];

    // Get survey data from each category section
    const categories = document.querySelectorAll('.category-section');
    
    categories.forEach(category => {
        const categoryTitle = category.querySelector('.category-title').textContent;
        
        // Get rating data from tables
        const ratingTable = category.querySelector('.ratings-comparison-table table');
        if (ratingTable) {
            const rows = ratingTable.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 4) {
                    allData.push({
                        'קטגוריה': categoryTitle,
                        'שאלה': cells[0].textContent,
                        'הערכת עובד': cells[1].textContent.split('(')[0].trim(),
                        'הערכת מנהל': cells[2].textContent.split('(')[0].trim(),
                        'פער': cells[3].textContent
                    });
                }
            });
        }

        // Get text comparison data
        const textComparisons = category.querySelectorAll('.text-comparison');
        textComparisons.forEach(comparison => {
            const question = comparison.querySelector('h6').textContent;
            const employeeAnswer = comparison.querySelector('.comparison-card:nth-child(1) p').textContent;
            const managerAnswer = comparison.querySelector('.comparison-card:nth-child(2) p').textContent;
            
            allData.push({
                'קטגוריה': categoryTitle,
                'שאלה': question,
                'תשובת עובד': employeeAnswer,
                'תשובת מנהל': managerAnswer,
                'סוג': 'שאלה פתוחה'
            });
        });
    });

    // Create worksheet from data
    const ws = XLSX.utils.json_to_sheet(allData, {origin: 'A1'});

    // Add employee and manager info
    const employeeInfo = {
        'שם העובד': document.getElementById('employeeName').textContent,
        'מחלקת עובד': document.getElementById('employeeDepartment').textContent,
        'תאריך תחילת עבודה': document.getElementById('employeeHireDate').textContent,
        'שם המנהל': document.getElementById('managerName').textContent,
        'מחלקת מנהל': document.getElementById('managerDepartment').textContent
    };

    // Add the workbook
    XLSX.utils.book_append_sheet(wb, ws, "סיכום משוב");

    // Generate Excel file
    const fileName = `סיכום משוב - ${employeeInfo['שם העובד']} - ${new Date().toLocaleDateString('he-IL')}.xlsx`;
    XLSX.writeFile(wb, fileName);
};
        // Helper function to get rating text
        const getRatingText = (value) => RATING_SCALE[value] || 'לא צוין';

        // Update the createComparisonSection function
        const createComparisonSection = (category, questions, data) => {
    const { employee, manager } = transformApiData(data);
    const section = createElement('div', {
        className: 'category-section'
    });

    // Add category title
    section.appendChild(createElement('h2', {
        className: 'category-title',
        innerHTML: category
    }));

    // Create rating questions section
    const ratingQuestions = questions.filter(q => q.type === 'rating');
    if (ratingQuestions.length > 0) {
        const chartContainer = createElement('div', {
            className: 'chart-container',
            style: `
                position: relative; 
                min-height: 300px;
                height: 60vh;
                max-height: 500px;
                width: 100%;
                margin: 20px 0;
            `
        });

        const canvas = createElement('canvas', {
            style: `
                display: block;
                width: 100% !important;
                height: 100% !important;
            `
        });
        chartContainer.appendChild(canvas);
        section.appendChild(chartContainer);

        const chartData = ratingQuestions.map(q => {
            const maxLength = window.innerWidth <= 768 ? 35 : 400;
            // Always use E_question for the display text
            const questionText = q.E_question;
            if (!questionText) {
                console.warn(`Missing E_question for schema: ${q.schema}`);
                return null;
            }
            return {
                question: questionText.substring(0, maxLength) + (questionText.length > maxLength ? '...' : ''),
                employee: employee[q.schema] || 0,
                manager: manager[q.schema] || 0
            };
        }).filter(Boolean); // Remove any null entries

        new Chart(canvas, {
            type: 'radar',
            data: {
                labels: chartData.map(d => d.question),
                datasets: [
                    {
                        label: 'הערכת עובד',
                        data: chartData.map(d => d.employee),
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.2)',
                        pointBackgroundColor: '#1e40af',
                        pointRadius: 4
                    },
                    {
                        label: 'הערכת מנהל',
                        data: chartData.map(d => d.manager),
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.2)',
                        pointBackgroundColor: '#059669',
                        pointRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 20
                },
                scales: {
                    r: {
                        min: 0,
                        max: 4,
                        ticks: {
                            stepSize: 1,
                            font: {
                                size: 12
                            }
                        },
                        pointLabels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        rtl: true,
                        labels: {
                            font: {
                                size: 14
                            },
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const label = context.dataset.label || '';
                                const value = context.raw;
                                return `${label}: ${getRatingText(value)}`;
                            }
                        }
                    }
                }
            }
        });

                // Add ratings comparison table with text values
                const ratingsTable = createElement('div', {
            className: 'ratings-comparison-table mt-4',
            innerHTML: `
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr class="table-secondary">
                                <th style="width: 40%;">שאלה</th>
                                <th style="width: 25%;">הערכת עובד</th>
                                <th style="width: 25%;">הערכת מנהל</th>
                                <th style="width: 10%;">פער</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ratingQuestions.map(q => {
                                if (!q.E_question) return '';
                                const empScore = employee[q.schema] || 0;
                                const mgrScore = manager[q.schema] || 0;
                                const gap = Math.abs(empScore - mgrScore);
                                return `
                                    <tr ${gap >= 2 ? 'class="table-warning"' : ''}>
                                        <td data-label="שאלה">${q.E_question}</td>
                                        <td data-label="הערכת עובד" class="text-center">
                                            <div>${getRatingText(empScore)}</div>
                                            <small class="text-muted">(${empScore})</small>
                                        </td>
                                        <td data-label="הערכת מנהל" class="text-center">
                                            <div>${getRatingText(mgrScore)}</div>
                                            <small class="text-muted">(${mgrScore})</small>
                                        </td>
                                        <td data-label="פער" class="text-center ${gap >= 2 ? 'text-danger fw-bold' : ''}">${gap}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3 text-muted small">
                    * שורות מודגשות מציינות פער משמעותי (2 נקודות או יותר) בין הערכת העובד למנהל
                </div>
            `
        });
        section.appendChild(ratingsTable);
    }

    // Add text comparisons
    const textQuestions = questions.filter(q => q.type === 'text');
    if (textQuestions.length > 0) {
        const textSection = createElement('div', {
            className: 'text-comparisons-section mt-4'
        });

        textQuestions.forEach(q => {
            if (!q.E_question) return;
            const textComparison = createElement('div', {
                className: 'text-comparison mb-4',
                innerHTML: `
                    <h6 class="mb-3">${q.E_question}</h6>
                    <div class="grid gap-4" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <div class="comparison-card">
                            <h6 class="text-primary mb-2">תשובת עובד</h6>
                            <p class="border rounded p-3 bg-light">${employee[q.schema] || 'לא נענה'}</p>
                        </div>
                        <div class="comparison-card">
                            <h6 class="text-success mb-2">תשובת מנהל</h6>
                            <p class="border rounded p-3 bg-light">${manager[q.schema] || 'לא נענה'}</p>
                        </div>
                    </div>
                `
            });
            textSection.appendChild(textComparison);
        });

        section.appendChild(textSection);
    }

    return section;
};

        // Initialize the comparison view
        const initializeComparison = async () => {
            try {
                const surveyId = new URLSearchParams(window.location.search).get('param').split('-')[0];

                // Fetch data
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        surveyId,
                        action: "summarize"
                    })
                });

                const data = await response.json();
                if (data.Manager_Notes) {
                    // Hide summary section and submit button
                    const summarySection = document.getElementById('summarySection');
                    const submitButton = document.getElementById('submitButton');

                    if (summarySection) {
                        summarySection.style.display = 'none';
                    }
                    if (submitButton) {
                        submitButton.style.display = 'none';
                    }

                    // Optionally, add a message showing the existing manager notes
                    const surveyContent = document.getElementById('surveyContent');
                    const notesSection = createElement('div', {
                        className: 'category-section',
                        innerHTML: `
                    <h2 class="category-title">מילות סיכום שנכתבו</h2>
                    <div class="p-4 bg-light rounded">
                        ${data.Manager_Notes}
                    </div>
                `
                    });
                    surveyContent.appendChild(notesSection);
                }
                // Populate employee info
                document.getElementById('employeeName').textContent = data.Employee?.DisplayName || '';
                document.getElementById('employeeDepartment').textContent = data.Employee?.Department || '';
                document.getElementById('employeeHireDate').textContent = new Date(data.Working_x0020_Start_x0020_Date).toLocaleDateString('he-IL');
                document.getElementById('managerName').textContent = data.Manager?.DisplayName || '';
                document.getElementById('managerDepartment').textContent = data.Manager?.Department || '';
                document.getElementById('managerEmail').textContent = data.Manager?.Email || '';

                // Create comparison sections
                const surveyContent = document.getElementById('surveyContent');
                Object.entries(categories).forEach(([category, questions]) => {
                    surveyContent.appendChild(createComparisonSection(category, questions, data));
                });
                document.getElementById('downloadExcel').addEventListener('click', generateExcel);
                // Set up submit button handler
                document.getElementById('submitButton').addEventListener('click', async () => {
                    const summaryNotes = document.getElementById('summaryNotes').value;
                    showLoading();
                    try {
                        const response = await fetch(API_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                surveyId,
                                action: "after-summarize",
                                summaryNotes
                            })
                        });

                        if (response.ok) {
            hideLoading();
            showAlert('הסיכום נשלח בהצלחה!', 'success');
            document.getElementById('summaryNotes').disabled = true;
            document.getElementById('submitButton').disabled = true;
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    } catch (error) {
        hideLoading();
        showAlert('אירעה שגיאה בשליחת הסיכום', 'error');
    }
                });

            } catch (error) {
                console.error('Error initializing comparison:', error);
                alert('אירעה שגיאה בטעינת הנתונים');
            }
        };

        // Start everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
    // Password button click handler
    document.getElementById('checkPasswordBtn').addEventListener('click', checkPassword);
    
    // Enter key handler for password input
    document.getElementById('passwordInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
});
    </script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "pc0h16zhh3");
    </script>
</body>

</html>