<!DOCTYPE html>
<html dir="rtl" lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משוב הדדי</title>
    <link rel="stylesheet" href="new_style.css?v=1.0">
    <!-- Bootstrap RTL CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

    <style>

    </style>
</head>

<body class="skeleton-content">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">טוען...</span>
        </div>
    </div>

    <!-- Header Section -->
    <header class="page-header">
        <div class="header-content">
            <!-- Skeleton Logo -->
            <div class="skeleton-content">
                <div class="placeholder-glow">
                    <span class="placeholder col-4" style="height: 50px;"></span>
                </div>
            </div>

            <!-- Real Logo -->
            <div class="real-content">
                <img src="https://raw.githubusercontent.com/roeiredlerabra/abra-on-boarding/main/img/_master_logo_%D7%90%D7%91%D7%A8%D7%90%20%D7%91%D7%9C%D7%91%D7%9F.gif"
                    alt="Company Logo" class="header-logo">
            </div>

            <!-- Text Content -->
            <div class="flex flex-col items-start">
                <!-- Skeleton Title -->
                <div class="skeleton-content">
                    <div class="placeholder-glow mb-2">
                        <span class="placeholder col-6"></span>
                    </div>
                    <div class="placeholder-glow">
                        <span class="placeholder col-4"></span>
                    </div>
                </div>

                <!-- Real Title -->
                <div class="real-content">
                    <h1 class="text-2xl font-bold">משוב הדדי</h1>
                    <div class="text-sm opacity-90">
                        תקופת הערכה: <span id="evaluationPeriod"></span>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container" style="width: 200px;">
                <div class="progress-text" id="progressText"></div>
                <div class="progress">
                    <div class="progress-bar" role="progressbar"></div>
                </div>
            </div>
            
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <div class="survey-container">
            <div class="survey-form-wrapper">
                <!-- Employee Info Section -->
                <div class="employee-info-header">
                    <div class="employee-info-grid">
                        <!-- Employee Section -->
                        <div class="info-section">
                            <!-- Skeleton Employee Info -->
                            <div class="skeleton-content">
                                <div class="placeholder-glow mb-3">
                                    <span class="placeholder col-4"></span>
                                </div>
                                <div class="info-item placeholder-glow mb-3">
                                    <span class="placeholder col-3"></span>
                                    <span class="placeholder col-6"></span>
                                </div>
                                <div class="info-item placeholder-glow mb-3">
                                    <span class="placeholder col-3"></span>
                                    <span class="placeholder col-4"></span>
                                </div>
                                <div class="info-item placeholder-glow mb-3">
                                    <span class="placeholder col-3"></span>
                                    <span class="placeholder col-7"></span>
                                </div>
                            </div>

                            <!-- Real Employee Info -->
                            <div class="real-content">
                                <h3 class="info-section-title">
                                    <i class="fas fa-user"></i> פרטי עובד
                                </h3>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-user-tag"></i> שם העובד/ת</span>
                                    <span class="info-value" id="employeeName"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-briefcase"></i> מחלקה</span>
                                    <span class="info-value" id="employeeDepartment"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-envelope"></i> דואר אלקטרוני</span>
                                    <span class="info-value" id="employeeEmail"></span>
                                </div>
                                <div class="info-row">
                                    <div class="info-item">
                                        <span class="info-label"><i class="fas fa-calendar-day"></i> תאריך תחילת
                                            עבודה</span>
                                        <span class="info-value" id="employeeHireDate"></span>
                                        <span class="info-value" id="employeeTenure"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manager Section -->
                        <div class="info-section">
                            <!-- Skeleton Manager Info -->
                            <div class="skeleton-content">
                                <div class="placeholder-glow mb-3">
                                    <span class="placeholder col-4"></span>
                                </div>
                                <div class="info-item placeholder-glow mb-3">
                                    <span class="placeholder col-3"></span>
                                    <span class="placeholder col-6"></span>
                                </div>
                                <div class="info-item placeholder-glow mb-3">
                                    <span class="placeholder col-3"></span>
                                    <span class="placeholder col-4"></span>
                                </div>
                                <div class="info-item placeholder-glow mb-3">
                                    <span class="placeholder col-3"></span>
                                    <span class="placeholder col-7"></span>
                                </div>
                            </div>

                            <!-- Real Manager Info -->
                            <div class="real-content">
                                <h3 class="info-section-title">
                                    <i class="fas fa-users-cog"></i> פרטי מנהל
                                </h3>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-user-tie"></i> שם המנהל/ת</span>
                                    <span class="info-value" id="managerName"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-briefcase"></i> מחלקה</span>
                                    <span class="info-value" id="managerDepartment"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label"><i class="fas fa-envelope"></i> דואר אלקטרוני</span>
                                    <span class="info-value" id="managerEmail"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Survey Form -->
                <form id="evaluationForm">
                    <!-- Skeleton Survey Content -->
                    <div class="skeleton-content">
                        <div class="category-section mb-4">
                            <div class="placeholder-glow mb-4">
                                <span class="placeholder col-3"></span>
                            </div>
                            <div class="questions-grid">
                                <div class="question-card mb-4">
                                    <div class="placeholder-glow mb-3">
                                        <span class="placeholder col-8"></span>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <span class="placeholder col-2 p-3"></span>
                                        <span class="placeholder col-2 p-3"></span>
                                        <span class="placeholder col-2 p-3"></span>
                                        <span class="placeholder col-2 p-3"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Real Survey Content -->
                    <div class="real-content">
                        <div id="surveyContent"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="footer-content">
            <!-- Skeleton Footer -->
            <div class="skeleton-content">
                <div class="placeholder-glow mb-2">
                    <span class="placeholder col-4"></span>
                </div>
                <div class="placeholder-glow">
                    <span class="placeholder col-3 p-3"></span>
                </div>
            </div>

            <!-- Real Footer -->
            <div class="real-content">
                <div>
                    <div class="text-sm opacity-75">תאריך מילוי</div>
                    <div id="submissionDate" class="font-medium"></div>
                </div>
                <button type="submit" class="submit-btn" form="evaluationForm">
                    <span class="submit-text">שלח הערכה</span>
                    <span class="loading-spinner hidden"></span>
                </button>
            </div>
        </div>
    </footer>
    <!-- Add in <head> -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Your existing JavaScript code goes here -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


    <script>
        // Configuration and Constants
        const API_ENDPOINT = 'https://prod-39.westeurope.logic.azure.com:443/workflows/37fef182446d4610b731450f081f43fc/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2zKGo49JL0waedwDDLfiCsk5S1p4-KMDvehVNazN_DA';
        const SURVEY_CONFIG = {
            position: {
                MANAGER: "MANAGER",
                EMPLOYEE: "EMPLOYEE"
            },
            ratingScale: {
                4: 'מצטיין',
                3: 'מעל לנדרש',
                2: 'עבודה ע"פ הנדרש',
                1: 'נדרש שיפור',
                0: 'לא רלוונטי לתפקיד'
            }
        };

        const categories = {
            'ידע מקצועי': [
                {
                    M_question: 'בקיאות במוצר – עד כמה העובד.ת מבין.ה לעומק את המוצר, כולל רכיבים טכניים ותפעוליים?',
                    E_question: 'בקיאות במוצר – עד כמה את.ה מבין.ה לעומק את המוצר, כולל רכיבים טכניים ותפעוליים?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'product_knowledge',
                    required: true,
                    ariaLabel: 'דירוג בקיאות במוצר',
                    description: 'הערכת רמת ההבנה והידע במוצר ורכיביו'
                },
                {
                    M_question: 'הכרות עם מתודולוגיות הפרויקט – באיזו מידה העובד.ת מיישם.ת את שיטות העבודה המתודולוגיות בפרויקטים השונים?',
                    E_question: 'הכרות עם מתודולוגיות הפרויקט – באיזו מידה את.ה מיישם.ת את שיטות העבודה המתודולוגיות בפרויקטים השונים?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'methodology_knowledge',
                    required: true,
                    ariaLabel: 'דירוג הכרות עם מתודולוגיות',
                    description: 'הערכת יישום שיטות העבודה בפרויקטים'
                },
                {
                    M_question: 'הכרות מקצועית עם סביבת הלקוחות – עד כמה העובד מבין את הצרכים העסקיים של הלקוחות ומתאים את הפתרונות בהתאם?',
                    E_question: 'הכרות מקצועית עם סביבת הלקוחות – עד כמה את.ה מבין.ה את הצרכים העסקיים של הלקוחות ומתאים.ה את הפתרונות בהתאם?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'client_environment_knowledge',
                    required: true,
                    ariaLabel: 'דירוג הכרות עם סביבת לקוחות',
                    description: 'הערכת הבנת צרכי הלקוח והתאמת פתרונות'
                },
                {
                    M_question: 'זיהוי הזדמנויות אצל הלקוח – עד כמה העובד.ת מזהה אפשרויות להרחבת פתרונות ושירותים קיימים?',
                    E_question:'זיהוי הזדמנויות אצל הלקוח – עד כמה את.ה מזהה אפשרויות להרחבת פתרונות ושירותים קיימים? ' ,
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'client_opportunities',
                    required: true,
                    ariaLabel: 'דירוג זיהוי הזדמנויות',
                    description: 'הערכת יכולת זיהוי הזדמנויות עסקיות'
                },
                {
                    M_question: 'השתתפות בוובינרים / העשרות מקצועיות – עד כמה העובד.ת משתתף.ת בלמידה והעשרה מתמשכת? עד כמה יוזם.ת או מגיב.ה להזדמנויות כאלה?',
                    E_question: 'השתתפות בוובינרים / העשרות מקצועיות – עד כמה את.ה משתתף.ת בלמידה והעשרה מתמשכת? עד כמה יוזם.ת הזדמנויות כאלה?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'professional_development',
                    required: true,
                    ariaLabel: 'דירוג השתתפות בהעשרה מקצועית',
                    description: 'הערכת מעורבות בפעילויות למידה והתפתחות'
                },
                {
                    M_question: 'הכרות עם מוצרים משלימים – עד כמה העובד.ת מכיר.ה מוצרים רלוונטיים נוספים שיכולים להשתלב עם הפרויקטים של מיקרוסופט?',
                    E_question: 'הכרות עם מוצרים משלימים – עד כמה את.ה מכיר.ה מוצרים רלוונטיים נוספים שיכולים להשתלב עם הפרויקטים של מיקרוסופט?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'complementary_products',
                    required: true,
                    ariaLabel: 'דירוג הכרות עם מוצרים משלימים',
                    description: 'הערכת ידע במוצרים משלימים ורלוונטיים'
                }
            ],
            'מיומנויות עבודה': [
                {
                    M_question: 'יכולת ניהול עצמי – עד כמה העובד.ת מצליח.ה לעבוד בצורה עצמאית תוך ייזום פתרונות, או זקוק.ה להכוונה מתמדת?',
                    E_question: 'יכולת ניהול עצמי – עד כמה את.ה מצליח.ה לעבוד בצורה עצמאית תוך ייזום פתרונות, או זקוק.ה להכוונה מתמדת?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'self_management',
                    required: true,
                    ariaLabel: 'דירוג יכולת ניהול עצמי',
                    description: 'הערכת יכולת עבודה עצמאית וייזום'
                },
                {
                    M_question: 'יכולת עבודה תחת לחץ –באיזו מידה מצליח.ה העובד.ת להתתמודד עם משימות דחופות או תחת עומס? ',
                    E_question:'יכולת עבודה תחת לחץ – באיזו מידה את.ה מתמודד.ת עם משימות דחופות או תחת עומס?' ,
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'pressure_handling',
                    required: true,
                    ariaLabel: 'דירוג עבודה תחת לחץ',
                    description: 'הערכת התמודדות עם מצבי לחץ ועומס'
                },
                {
                    M_question: 'אחריות מקצועית –עד כמה העובד.ת לוקח.ת אחריות מלאה על המשימות שלו.ה, כולל תיקון טעויות ושיפור?',
                    E_question: 'אחריות מקצועית – עד כמה את.ה לוקח.ת אחריות מלאה על המשימות שלך, כולל תיקון טעויות ושיפור?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'professional_responsibility',
                    required: true,
                    ariaLabel: 'דירוג אחריות מקצועית',
                    description: 'הערכת רמת האחריות והמחויבות למשימות'
                },
                {
                    M_question: 'שיתוף פעולה ועבודת צוות – באיזו מידה העובד.ת משתף.ת פעולה ומכבד.ת דעות שונות בצוות?',
                    E_question: 'שיתוף פעולה ועבודת צוות – באיזו מידה את.ה משתף.ת פעולה ומכבד.ת דעות שונות בצוות?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'team_collaboration',
                    required: true,
                    ariaLabel: 'דירוג שיתוף פעולה',
                    description: 'הערכת יכולת עבודה בצוות ושיתוף פעולה'
                },
                {
                    M_question: 'הקפדה על נהלים – באיזו מידה העובד.ת מקפיד.ה על נהלי העבודה?',
                    E_question: 'הקפדה על נהלים – באיזו מידה את.ה מקפיד.ה על נהלי העבודה?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'procedure_adherence',
                    required: true,
                    ariaLabel: 'דירוג הקפדה על נהלים',
                    description: 'הערכת מידת ההקפדה על נהלי העבודה'
                },
                {
                    M_question: 'תקשורת אפקטיבית – באיזו מידה מצליח.ה העובד.ת לנהל תקשורת אפקטיבית עם ממשקי העבודה?',
                    E_question: 'תקשורת אפקטיבית – באיזו מידה את.ה מנהל.ת תקשורת אפקטיבית עם ממשקי עבודה?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'effective_communication',
                    required: true,
                    ariaLabel: 'דירוג תקשורת אפקטיבית',
                    description: 'הערכת יכולת תקשורת עם צוותים שונים'
                }
            ],
            'גישה ומוטיבציה': [
                {
                    M_question: 'מעורבות חברתית – עד כמה העובד.ת תורם.ת לאווירה החברתית והמקצועית בצוות או בחטיבה?',
                    E_question: 'מעורבות חברתית – עד כמה את.ה תורם.ת לאווירה החברתית והמקצועית בצוות או בחטיבה?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'social_involvement',
                    required: true,
                    ariaLabel: 'דירוג מעורבות חברתית',
                    description: 'הערכת תרומה לאווירה החברתית בצוות'
                },
                {
                    M_question: 'קבלת ביקורת – כיצד העובד.ת מתמודד עם ביקורות ומשובים? ',
                    E_question:'קבלת ביקורת – באיזו מידה את.ה מתמודד.ת עם קבלת ביקורת בונה ומשובים?' ,
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'feedback_reception',
                    required: true,
                    ariaLabel: 'דירוג קבלת ביקורת',
                    description: 'הערכת התמודדות עם משוב וביקורת'
                },
                {
                    M_question: 'מוטיבציה לייעול ושיפור – באיזו מידה העובד.ת תורם.ת לשיפור העבודה תוך העלאת רעיונות חדשים או יוזמות?',
                    E_question: 'מוטיבציה לייעול ושיפור – עד כמה, לתחושתך, את.ה תורם.ת לשיפור העבודה תוך העלאת רעיונות חדשים או יוזמות?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'improvement_motivation',
                    required: true,
                    ariaLabel: 'דירוג מוטיבציה לשיפור',
                    description: 'הערכת יוזמה לשיפור תהליכים'
                },
                {
                    M_question: 'למידה עצמאית – עד כמה העובד.ת מראה יוזמה ללמידה מתמשכת ללא צורך בהנחיה?',
                    E_question: 'למידה עצמאית – עד כמה את.ה מראה יוזמה ללמידה מתמשכת ללא צורך בהנחיה?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'self_learning',
                    required: true,
                    ariaLabel: 'דירוג למידה עצמאית',
                    description: 'הערכת יוזמה ללמידה והתפתחות עצמאית'
                }
            ],
            'סגנון עבודה': [
                {
                    M_question: 'סדר וארגון בעבודה – עד כמה העובד.ת שומר.ת על סביבת עבודה מאורגנת ומסודרת, תוך ניהול זמן ומשימות באופן יעיל?',
                    E_question: 'סדר וארגון בעבודה – עד כמה את.ה שומר.ת על סביבת עבודה מאורגנת ומסודרת, תוך ניהול זמן ומשימות באופן יעיל?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'work_organization',
                    required: true,
                    ariaLabel: 'דירוג סדר וארגון',
                    description: 'הערכת ארגון וסדר בסביבת העבודה'
                },
                {
                    M_question: 'עמידה בזמנים – באיזו מידה העובד.ת מקפיד.ה על עמידה בלוחות זמנים והגשת משימות בזמן?',
                    E_question: 'עמידה בזמנים – באיזו מידה את.ה מקפיד.ה על עמידה בלוחות זמנים והגשת משימות בזמן?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'time_management',
                    required: true,
                    ariaLabel: 'דירוג עמידה בזמנים',
                    description: 'הערכת עמידה בלוחות זמנים'
                },
                {
                    M_question: 'ניהול פרויקטים – האם העובד מצליח לנהל פרויקטים תוך שמירה על יעדים ברורים?',
                    E_question:'ניהול פרויקטים – באיזו מידה את.ה מצליח.ה לנהל פרויקטים תוך שמירה על יעדים ברורים ותוצרים איכותיים?',
                    type: 'rating',
                    roles: [0, 1],
                    schema: 'project_management',
                    required: true,
                    ariaLabel: 'דירוג ניהול פרויקטים',
                    description: 'הערכת יכולת ניהול פרויקטים ועמידה ביעדים'
                }
            ],
            'הערכה מסכמת': [
                {
                    M_question: 'תחומים לשיפור – אילו תחומים אצל העובד.ת את.ה מזהה שבהם יוכל.תוכל להשתפר? מה צריך.ה לעשות כדי להגיע לשם? תן דוגמאות.',
                    E_question: 'תחומים לשיפור – אילו תחומים את.ה מזהה שבהם תוכל.י להשתפר? מה תעשה.י כדי להגיע לשם? תן דוגמאות.',
                    type: 'text',
                    roles: [0, 1],
                    schema: 'improvement_areas',
                    required: true,
                    ariaLabel: 'תחומים לשיפור',
                    description: 'פירוט תחומים הדורשים שיפור'
                },
                {
                    M_question: 'הישגים בולטים – מהם ההישגים המרכזיים שהעובד.ת השיג.ה בתקופה האחרונה? תן דוגמאות.',
                    E_question: 'הישגים בולטים – מהם ההישגים המרכזיים שהשגת בתקופה האחרונה? תן דוגמאות.',
                    type: 'text',
                    roles: [0, 1],
                    schema: 'key_achievements',
                    required: true,
                    ariaLabel: 'הישגים בולטים',
                    description: 'פירוט הישגים משמעותיים בתקופה האחרונה'
                },
                
                {
                    M_question: 'פוקוס לשנה הבאה- על מה תשמח.י לראות את העובד.ת מתמקד.ת בשנה הקרובה בהיבטים מקצועיים ובינאישיים?',
                    E_question: 'פוקוס לשנה הבאה- על מה את.ה מתכנן.ת להתמקד בשנה הקרובה בהיבטים מקצועיים ובינאישיים?',
                    type: 'text',
                    roles: [0, 1],
                    schema: 'future_goals',
                    required: true,
                    ariaLabel: 'יעדים לתקופה הבאה',
                    description: 'הגדרת יעדים לתקופה הבאה'
                },
                {
                    M_question: 'הערות נוספות – האם יש הערות או תובנות נוספות שברצונך לשתף?',
                    E_question:'הערות נוספות – האם יש הערות או תובנות נוספות שברצונך לשתף?' ,
                    type: 'text',
                    roles: [0, 1],
                    schema: 'additional_comments',
                    required: true,
                    ariaLabel: 'הערות נוספות',
                    description: 'מקום להערות ותובנות נוספות'
                }
            ],
            'מיומנויות ניהוליות': [
                {
                    M_question: 'קבלת החלטות – כמנהל.ת פרויקטים או צוות, עד כמה העובד.ת מקבל.ת החלטות במהירות ובביטחון, תוך הערכה נכונה של המצב? ',
                    E_question: 'קבלת החלטות – כמנהל.ת פרויקטים או צוות, עד כמה את.ה מקבל.ת החלטות במהירות ובביטחון, תוך הערכה נכונה של המצב?   ',
                    type: 'rating',
                    roles: [1],
                    schema: 'decision_making',
                    required: true,
                    ariaLabel: 'דירוג קבלת החלטות',
                    description: 'הערכת יכולת קבלת החלטות מהירה ומדויקת'
                },
                {
                    M_question: 'באיזו מידה העובד.ת מצליח.ה לדאוג לניהול זמן או משימות אפקטיבי של הצוות, תוך הקפדה עלל סדר עדיפויות ברור? ',
                    E_question:'ניהול זמן וסדר עדיפויות – באיזו מידה את.ה מצליח.ה לדאוג לניהול זמן או משימות אפקטיבי של הצוות, תוך הקפדה עלל סדר עדיפויות ברור? ' ,
                    type: 'rating',
                    roles: [1],
                    schema: 'time_priority_management',
                    required: true,
                    ariaLabel: 'דירוג ניהול זמן וסדרי עדיפויות',
                    description: 'הערכת יכולת ניהול זמן ותעדוף משימות'
                },
                {
                    M_question: 'גמישות והתאמה לשינויים – באיזו מידה העובד.ת מצליח.ה להסתגל ולהתמודד עם שינויים בפרויקטים או בסדרי העדיפויות, תוך הובלת הצוות בהתאם? ',
                    E_question: 'גמישות והתאמה לשינויים – באיזו מידה את.ה מצליח.ה להסתגל ולהתמודד עם שינויים בפרויקטים או בסדרי העדיפויות, תוך הובלת הצוות בהתאם? ',
                    type: 'rating',
                    roles: [1],
                    schema: 'change_adaptation',
                    required: true,
                    ariaLabel: 'דירוג גמישות והסתגלות',
                    description: 'הערכת יכולת הסתגלות לשינויים'
                },
                {
                    M_question: 'באיזו מידה העובד.ת כמנהל.ת פרויקט או צוות, מציב.ה לעובדיו יעדים ברורים, מדידים וברי השגה?',
                    E_question:'הצבת יעדים ברורים – באיזו מידה את.ה כמנהל.ת פרויקט או צוות, מציב.ה לעובדיו יעדים ברורים, מדידים וברי השגה? ' ,
                    type: 'rating',
                    roles: [1],
                    schema: 'goal_setting',
                    required: true,
                    ariaLabel: 'דירוג הצבת יעדים',
                    description: 'הערכת יכולת הגדרת יעדים ברורים לצוות'
                },
                {
                    M_question: 'באיזו מידה העובד.ת מצליח.ה לגרום לעובדים.ות לבצע את משימותיהם בצורה הטובה ביותר?',
                    E_question: 'יכולת הנעה– באיזו מידה את.ה כמנהל.ת מצליח.ה לגרום לעובדים.ות לבצע את משימותיהם בצורה הטובה ביותר? ',
                    type: 'rating',
                    roles: [1],
                    schema: 'team_motivation',
                    schema: 'team_motivation',
                    required: true,
                    ariaLabel: 'דירוג הנעת עובדים',
                    description: 'הערכת יכולת הנעת העובדים להשגת ביצועים מיטביים'
                },
                {
                    M_question: 'ניצול משאבים – עד כמה העובד.ת מצליח.ה לנצל את המשאבים העומדים לרשותו (כגון תקציב ולוחות זמנים) באופן אפקטיבי? ',
                    E_question: 'ניצול משאבים – עד כמה אתה כמנהל.ת מצליח.ה לנצל את המשאבים העומדים לרשותך (כגון תקציב ולוחות זמנים) באופן אפקטיבי? ',
                    type: 'rating',
                    roles: [1],
                    schema: 'resource_utilization',
                    required: true,
                    ariaLabel: 'דירוג ניצול משאבים',
                    description: 'הערכת יכולת ניצול יעיל של משאבי הארגון'
                },
                {
                    M_question: 'קידום ופיתוח עובדים – באיזו מידה העובד.ת כמנהל.ת פרויקט או צוות, מצליח.ה לקדם את עובדיו, לפתח אותם מקצועית ואישית?',
                    E_question: 'קידום ופיתוח עובדים – באיזו מידה אתה כמנהל.ת פרויקט או צוות, מצליח.ה לקדם את עובדיך, לפתח אותם מקצועית ואישית? ',
                    type: 'rating',
                    roles: [1],
                    schema: 'employee_development',
                    required: true,
                    ariaLabel: 'דירוג פיתוח עובדים',
                    description: 'הערכת יכולת פיתוח וקידום הצוות'
                },
                {
                    M_question: 'עד כמה העובד.ת מצליח.ה ללמוד מהצלחות ואי-הצלחות, תוך יישום הלקחים לצורך שיפור ביצועים עתידיים? ',
                    E_question:'הפקת לקחים –  עד כמה את.ה מצליח.ה ללמוד מהצלחות ואי-הצלחות, תוך יישום הלקחים לצורך שיפור ביצועים עתידיים? ' ,
                    type: 'rating',
                    roles: [1],
                    schema: 'lessons_learned',
                    required: true,
                    ariaLabel: 'דירוג למידה מלקחים',
                    description: 'הערכת יכולת הפקת לקחים ויישומם'
                }
                
            ]
          
            
        };
        const isSurveyAlreadyFilled = (surveyData, surveyParams) => {
            if (!surveyData || !surveyParams) return false;

            // Access the properties directly as they appear in your API response
            const managerFilled = surveyData.ManagerFilled;
            const employeeFilled = surveyData.EmployeeFilled;



            // Check if manager survey is filled
            if (surveyParams.position === 'MANAGER' && managerFilled === "1") {
                return true;
            }

            // Check if employee survey is filled
            if (surveyParams.position === 'EMPLOYEE' && employeeFilled === "1") {
                return true;
            }

            return false;
        };

        // Add this function to show the "already filled" message
        const showSurveyFilledMessage = (position) => {
            const surveyContent = document.getElementById('surveyContent');
            const footer = document.querySelector('.page-footer');

            // Create message element
            const messageDiv = createElement('div', {
                className: 'category-section text-center',
                innerHTML: `
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading mb-3 font-bold text-xl">
                    ${position === 'MANAGER' ? 'משוב מנהל כבר מולא' : 'משוב עובד כבר מולא'}
                </h4>
                <p class="mb-0">
                    ${position === 'MANAGER'
                        ? 'כבר מילאת את המשוב עבור העובד/ת זה. לא ניתן למלא את המשוב פעם נוספת.'
                        : 'כבר מילאת את המשוב שלך. לא ניתן למלא את המשוב פעם נוספת.'}
                </p>
            </div>
        `
            });

            // Clear existing content and add message
            surveyContent.innerHTML = '';
            surveyContent.appendChild(messageDiv);

            // Hide the footer with submit button
            if (footer) {
                footer.style.display = 'none';
            }
        };

        const populateEmployeeInfo = (data) => {
            if (!data) {
                console.error('No data provided to populateEmployeeInfo');
                return;
            }

            try {
                // Employee details
                if (data.Employee) {
                    document.getElementById('employeeName').textContent = data.Employee.DisplayName || '';
                    document.getElementById('employeeEmail').textContent = data.Employee.Email || '';
                    document.getElementById('employeeDepartment').textContent = data.Employee.Department || '';
                }


                // Handle the date
                if (data.Working_x0020_Start_x0020_Date) {
                    const startDate = new Date(data.Working_x0020_Start_x0020_Date);
                    const today = new Date();

                    // Format the start date in Hebrew
                    document.getElementById('employeeHireDate').textContent = startDate.toLocaleDateString('he-IL');

                    // Calculate tenure
                    let years = today.getFullYear() - startDate.getFullYear();
                    let months = today.getMonth() - startDate.getMonth();
                    let days = today.getDate() - startDate.getDate();

                    // Adjust for negative days
                    if (days < 0) {
                        months -= 1;
                        const previousMonth = new Date(today.getFullYear(), today.getMonth(), 0);
                        days += previousMonth.getDate();
                    }

                    // Adjust for negative months
                    if (months < 0) {
                        years -= 1;
                        months += 12;
                    }

                    // Populate the tenure field in Hebrew
                    document.getElementById('employeeTenure').textContent =
                        `(${years} שנים, ${months} חודשים, ${days} ימים)`;
                }



                // Manager details
                if (data.Manager) {
                    document.getElementById('managerName').textContent = data.Manager.DisplayName || '';
                    document.getElementById('managerEmail').textContent = data.Manager.Email || '';
                    document.getElementById('managerDepartment').textContent = data.Manager.Department || '';
                }

                // Evaluation period
                document.getElementById('evaluationPeriod').textContent = new Date().getFullYear();
                document.getElementById('submissionDate').textContent = new Date().toLocaleDateString('he-IL');

            } catch (error) {
                console.error('Error in populateEmployeeInfo:', error);
            }
        };
        // DOM Helper Functions
        const createElement = (tag, attributes = {}, children = []) => {
            const element = document.createElement(tag);
            Object.entries(attributes).forEach(([key, value]) => {
                if (key === 'className') {
                    element.className = value;
                } else if (key === 'innerHTML') {
                    element.innerHTML = value;
                } else {
                    element.setAttribute(key, value);
                }
            });
            children.forEach(child => element.appendChild(child));
            return element;
        };

        // Survey Elements Creation
        const createQuestionLabel = (questionObj, position) => {
            // Determine which question text to use based on position
            const questionText = position === 'EMPLOYEE' && questionObj.E_question ?
                questionObj.E_question : questionObj.M_question;

            return createElement('div', {
                id: `${questionObj.schema}-label`,
                className: 'mb-1',
                innerHTML: `
            <div class="text-lg font-semibold text-gray-700 mb-2">
                ${questionText}
                ${questionObj.required ? '<span class="required-marker">*</span>' : ''}
            </div>
        `
            });
        };

        const createRatingInput = (questionObj, value, label) => {
            const optionDiv = createElement('div', {
                className: 'rating-option flex-1'
            });

            const optionLabel = createElement('label', {
                className: 'w-full h-full flex flex-col items-center p-3 rounded-lg',
                innerHTML: `
            <input type="radio" 
                   name="${questionObj.schema}" 
                   value="${value}"
                   ${questionObj.required ? 'required' : ''}
                   class="hidden"
                   aria-label="${questionObj.ariaLabel} - ${label}"
                   aria-required="${questionObj.required}">
            <div class="text-center rounded-lg px-4 py-2 w-full transition-all duration-200">
                ${label}
            </div>
        `
            });

            optionDiv.appendChild(optionLabel);
            return optionDiv;
        };

        const createTextArea = (questionObj) => {
            return createElement('textarea', {
                className: 'w-full p-3 min-h-[120px] resize-y',
                name: questionObj.schema,
                required: questionObj.required,
                'aria-label': questionObj.ariaLabel,
                'aria-required': questionObj.required,
                placeholder: 'הכנס את תשובתך כאן...'
            });
        };

        const createRatingQuestion = (questionObj, position) => {
            const questionDiv = createElement('div', {
                className: 'question-card',
                role: 'group',
                'aria-labelledby': `${questionObj.schema}-label`
            });

            const questionLabel = createQuestionLabel(questionObj, position);
            const ratingScaleDiv = createElement('div', {
                className: 'rating-scale',
                role: 'radiogroup',
                'aria-describedby': `${questionObj.schema}-description`
            });

            if (questionObj.type === 'rating') {
                Object.entries(SURVEY_CONFIG.ratingScale)
                    .reverse()
                    .forEach(([value, label]) => {
                        ratingScaleDiv.appendChild(createRatingInput(questionObj, value, label));
                    });
            } else if (questionObj.type === 'text') {
                ratingScaleDiv.appendChild(createTextArea(questionObj));
            }

            questionDiv.appendChild(questionLabel);
            questionDiv.appendChild(ratingScaleDiv);
            return questionDiv;
        };

        const updateProgress = () => {
    const questionCards = document.querySelectorAll('.question-card');
    let totalQuestions = 0;
    let answeredQuestions = 0;

    questionCards.forEach(card => {
        const radioGroup = card.querySelector('input[type="radio"]');
        const textarea = card.querySelector('textarea');

        if (radioGroup || textarea) {
            totalQuestions++;

            if (radioGroup) {
                const groupName = radioGroup.getAttribute('name');
                const isAnswered = card.querySelector(`input[name="${groupName}"]:checked`);
                if (isAnswered) {
                    answeredQuestions++;
                }
            } else if (textarea) {
                if (textarea.value.trim()) {
                    answeredQuestions++;
                }
            }
        }
    });

    // Get progress bar elements
    const progressBar = document.querySelector('.progress-bar');
    const progressContainer = document.querySelector('.progress');

    if (progressBar) {
        // Calculate progress percentage
        const progress = totalQuestions > 0 ? (answeredQuestions / totalQuestions) * 100 : 0;
        progressBar.style.width = `${Math.round(progress)}%`;

        // Change color to green when all questions are answered
        if (answeredQuestions === totalQuestions) {
            progressBar.style.backgroundColor = '#22C55E'; // Green color
        } else {
            progressBar.style.backgroundColor = '#2196F3'; // Default blue color
        }

        // Update progress text
        const progressText = document.getElementById('progressText');
        if (progressText) {
            progressText.textContent = `נענו ${answeredQuestions} שאלות מתוך ${totalQuestions}`;
        }

        // Add styles


        // Only add the style tag if it hasn't been added before
        if (!document.head.querySelector('style')) {
            document.head.appendChild(style);
        }
    }
};

        // Form Data Management
        const collectFormData = (form) => {
            const formData = new FormData(form);
            const surveyParams = getSurveyParams();

            const results = {
                surveyId: surveyParams.surveyId,
                role: surveyParams.role,
                position: surveyParams.position,
                timestamp: new Date().toISOString(),
                action: 'submitform',
                answers: {}
            };

            formData.forEach((value, key) => {
                results.answers[key] = value;
            });

            return results;
        };



        // URL Parameter Handling
        const getSurveyParams = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const param = urlParams.get('param');

            if (!param) {
                throw new Error('Invalid survey parameters');
            }

            const [id, position] = param.split('-');

            return {
                surveyId: id,
                position
            };
        };

        // Survey Loading and Initialization
        const loadSurvey = (surveyParams, managmentRole) => {
            const surveyContent = document.getElementById('surveyContent');
            surveyContent.innerHTML = '';

            // Convert management role to integer for comparison
            const roleNumber = parseInt(managmentRole);

            Object.entries(categories).forEach(([category, questions]) => {
                // Filter questions based on management role
                const filteredQuestions = questions.filter(q => q.roles.includes(roleNumber));

                // Skip if no questions match the role
                if (filteredQuestions.length === 0) {
                    return;
                }

                // Skip managerial section for non-managers
                if (category === 'מיומנויות ניהוליות' && roleNumber === 0) {
                    return;
                }

                // Create category section
                const categorySection = createElement('div', {
                    className: 'category-section'
                });

                const categoryHeader = createElement('h2', {
                    className: 'category-title',
                    innerHTML: category
                });

                const questionsGrid = createElement('div', {
                    className: 'questions-grid'
                });

                // Add filtered questions with position parameter
                filteredQuestions.forEach(q =>
                    questionsGrid.appendChild(createRatingQuestion(q, surveyParams.position))
                );

                categorySection.appendChild(categoryHeader);
                categorySection.appendChild(questionsGrid);
                surveyContent.appendChild(categorySection);
            });

            updateProgress();
        };
        // Add this function to your JavaScript
        const downloadExcel = () => {
    // Get survey parameters and form data
    const surveyParams = getSurveyParams();
    const form = document.getElementById('evaluationForm');
    const formData = new FormData(form);
    const answers = {};
    formData.forEach((value, key) => {
        answers[key] = value;
    });

    // Create worksheet data
    const wsData = [];

    // Add header row
    wsData.push(['קטגוריה', 'שאלה', 'תשובה']);

    // Add employee info section
    wsData.push(['פרטי עובד', 'שם', document.getElementById('employeeName').textContent]);
    wsData.push(['פרטי עובד', 'מחלקה', document.getElementById('employeeDepartment').textContent]);
    wsData.push(['פרטי עובד', 'דואר אלקטרוני', document.getElementById('employeeEmail').textContent]);
    wsData.push(['פרטי עובד', 'תאריך תחילת עבודה', document.getElementById('employeeHireDate').textContent]);
    wsData.push([]);  // Empty row for spacing

    // Add manager info section
    wsData.push(['פרטי מנהל', 'שם', document.getElementById('managerName').textContent]);
    wsData.push(['פרטי מנהל', 'מחלקה', document.getElementById('managerDepartment').textContent]);
    wsData.push(['פרטי מנהל', 'דואר אלקטרוני', document.getElementById('managerEmail').textContent]);
    wsData.push([]);  // Empty row for spacing

    // Add evaluation period and submission date
    wsData.push(['פרטי הערכה', 'תקופת הערכה', document.getElementById('evaluationPeriod').textContent]);
    wsData.push(['פרטי הערכה', 'תאריך מילוי', document.getElementById('submissionDate').textContent]);
    wsData.push([]);  // Empty row for spacing

    // Add survey answers
    Object.entries(categories).forEach(([category, questions]) => {
        questions.forEach(question => {
            const answer = answers[question.schema];
            if (answer) { // Only add if there's an answer
                // Get the correct question text based on position
                const questionText = surveyParams.position === 'EMPLOYEE' ? 
                    question.E_question : 
                    question.M_question;

                // Format the answer based on question type
                let displayAnswer = answer;
                if (question.type === 'rating' && answer) {
                    displayAnswer = SURVEY_CONFIG.ratingScale[answer];
                }

                wsData.push([
                    category,
                    questionText,
                    displayAnswer || ''
                ]);
            }
        });
        wsData.push([]); // Empty row between categories
    });

    // Create workbook
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Set RTL and column widths
    ws['!dir'] = 'rtl';
    ws['!cols'] = [
        { wch: 20 },  // Category width
        { wch: 50 },  // Question width
        { wch: 30 }   // Answer width
    ];

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, "הערכת עובד");

    // Generate filename with position indicator
    const employeeName = document.getElementById('employeeName').textContent;
    const date = new Date().toLocaleDateString('he-IL').replace(/\./g, '-');
    const position = surveyParams.position === 'EMPLOYEE' ? 'עובד' : 'מנהל';
    const filename = `הערכת_${position}_${employeeName}_${date}.xlsx`;

    // Download file
    XLSX.writeFile(wb, filename);
};




        // Add this to your HTML before the submit button in the footer
        const addDownloadButton = () => {
            const downloadBtn = createElement('button', {
                id: 'downloadExcelBtn',
                className: 'submit-btn',
                type: 'button',
                style: 'display: none; background: #059669;',
                innerHTML: 'הורדה לאקסל',
                onclick: 'downloadExcel()'
            });

            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.parentNode.insertBefore(downloadBtn, submitBtn);
        };



        // Form Submission
        const submitSurvey = async (data) => {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            return response.json();
        };

        const handleSubmit = async (event) => {
            event.preventDefault();

            const form = event.target;
            const requiredFields = form.querySelectorAll('[required]');
            let unansweredQuestions = [];
            let isValid = true;
            let firstErrorElement = null;

            // Group radio buttons by name to avoid duplicates
            const radioGroups = new Set();

            // Reset any existing error states
            form.querySelectorAll('.error').forEach(element => {
                element.classList.remove('error');
            });

            requiredFields.forEach(field => {
                if (field.type === 'radio') {
                    const groupName = field.name;

                    // Only check each radio group once
                    if (!radioGroups.has(groupName)) {
                        radioGroups.add(groupName);
                        const checkedRadio = form.querySelector(`input[name="${groupName}"]:checked`);

                        if (!checkedRadio) {
                            isValid = false;
                            const questionCard = field.closest('.question-card');
                            if (questionCard) {
                                questionCard.classList.add('error');
                                if (!firstErrorElement) {
                                    firstErrorElement = questionCard;
                                }
                                // Get the question text and category
                                const questionLabel = questionCard.querySelector(`#${groupName}-label .text-lg`);
                                const categoryTitle = questionCard.closest('.category-section').querySelector('.category-title');
                                if (questionLabel && categoryTitle) {
                                    unansweredQuestions.push({
                                        category: categoryTitle.textContent,
                                        question: questionLabel.textContent.split('–')[0].trim()
                                    });
                                }
                            }
                        }
                    }
                } else if (!field.value.trim()) {
                    isValid = false;
                    const questionCard = field.closest('.question-card');
                    if (questionCard) {
                        questionCard.classList.add('error');
                        if (!firstErrorElement) {
                            firstErrorElement = questionCard;
                        }
                        // Get the question text and category for textarea
                        const questionLabel = questionCard.querySelector(`#${field.name}-label .text-lg`);
                        const categoryTitle = questionCard.closest('.category-section').querySelector('.category-title');
                        if (questionLabel && categoryTitle) {
                            unansweredQuestions.push({
                                category: categoryTitle.textContent,
                                question: questionLabel.textContent.split('–')[0].trim()
                            });
                        }
                    }
                }
            });

            if (!isValid) {
                // Group questions by category
                const groupedQuestions = unansweredQuestions.reduce((acc, { category, question }) => {
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(question);
                    return acc;
                }, {});

                // Format the message with categories
                let formattedMessage = '<div style="text-align: right; margin-bottom: 1rem;">אנא השלם את השאלות הבאות:</div><div style="text-align: right; max-height: 300px; overflow-y: auto;">';

                Object.entries(groupedQuestions).forEach(([category, questions]) => {
                    formattedMessage += `<div style="margin-bottom: 1rem;">
                <strong>${category}:</strong>
                <ul style="list-style-type: none; padding-right: 1rem; margin-top: 0.5rem;">
                    ${questions.map(q => `<li style="margin-bottom: 0.5rem;">• ${q}</li>`).join('')}
                </ul>
            </div>`;
                });

                formattedMessage += '</div>';

                showCustomPopup({
                    type: 'error',
                    title: 'שאלות חובה שלא נענו',
                    message: formattedMessage,
                    showConfirm: true,
                    showCancel: false
                });

                if (firstErrorElement) {
                    firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            const submitBtn = document.querySelector('button[form="evaluationForm"]');
            const downloadBtn = document.getElementById('downloadExcelBtn');

            // Show confirmation popup if form is valid
            showCustomPopup({
                type: 'warning',
                title: 'אישור שליחה',
                message: 'האם אתה בטוח שברצונך לשלוח את ההערכה?',
                showConfirm: true,
                showCancel: true,
                onConfirm: async () => {
                    try {
                        submitBtn.disabled = true;
                        const submitText = submitBtn.querySelector('.submit-text');
                        const loadingSpinner = submitBtn.querySelector('.loading-spinner');

                        if (submitText) submitText.style.display = 'none';
                        if (loadingSpinner) loadingSpinner.classList.remove('hidden');

                        const results = collectFormData(form);
                        const response = await submitSurvey(results);

                        submitBtn.style.display = 'none';
                        if (downloadBtn) downloadBtn.style.display = 'block';

                        showCustomPopup({
                            type: 'success',
                            title: 'ההערכה נשלחה בהצלחה!',
                            message: `
                        <div class="download-prompt">
                            <p>האם תרצה להוריד את ההערכה כקובץ אקסל?</p>
                        </div>
                    `,
                            showConfirm: true,
                            showCancel: true,
                            onConfirm: () => {
                                downloadExcel();
                            }
                        });

                        disableForm(form);

                    } catch (error) {
                        console.error('Error submitting survey:', error);
                        showCustomPopup({
                            type: 'error',
                            title: 'שגיאה',
                            message: error.message || 'אירעה שגיאה בשליחת הטופס'
                        });
                    } finally {
                        const submitText = submitBtn.querySelector('.submit-text');
                        const loadingSpinner = submitBtn.querySelector('.loading-spinner');

                        if (submitText) submitText.style.display = 'block';
                        if (loadingSpinner) loadingSpinner.classList.add('hidden');
                        submitBtn.disabled = false;
                    }
                }
            });
        };
        const fetchSurveyData = async (params) => {
            try {


                const response = await fetch(`https://prod-39.westeurope.logic.azure.com:443/workflows/37fef182446d4610b731450f081f43fc/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=2zKGo49JL0waedwDDLfiCsk5S1p4-KMDvehVNazN_DA`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        surveyId: params.surveyId,
                        position: params.position,
                        action: "getsurveydata"
                    })
                });

                if (!response.ok) {
                    showCustomPopup({
                        type: 'error',
                        title: 'שגיאת שרת',
                        message: `השרת החזיר שגיאה: ${response.status} - ${response.statusText}. אנא נסה שוב מאוחר יותר או פנה לתמיכה.`,
                        showConfirm: true,
                        showCancel: false
                    });
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                // Verify data structure
                if (!data || typeof data !== 'object') {
                    showCustomPopup({
                        type: 'error',
                        title: 'שגיאת מידע',
                        message: 'התקבל מידע לא תקין מהשרת. אנא נסה שוב או פנה לתמיכה.',
                        showConfirm: true,
                        showCancel: false
                    });
                    throw new Error('Invalid data received from server');
                }

                return {
                    managment: data.managment || "0",
                    Manager: data.Manager || null,
                    Employee: data.Employee || null,
                    Working_x0020_Start_x0020_Date: data.Working_x0020_Start_x0020_Date || "",
                    ManagerFilled: data.ManagerFilled || "0",
                    EmployeeFilled: data.EmployeeFilled || "0"
                };
            } catch (error) {
                // Handle network errors
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showCustomPopup({
                        type: 'error',
                        title: 'שגיאת תקשורת',
                        message: 'לא ניתן להתחבר לשרת. אנא בדוק את חיבור האינטרנט שלך ונסה שוב.',
                        showConfirm: true,
                        showCancel: false
                    });
                } else if (!error.message.includes('HTTP error')) { // Don't show another popup for HTTP errors
                    showCustomPopup({
                        type: 'error',
                        title: 'שגיאה',
                        message: 'אירעה שגיאה לא צפויה. אנא נסה שוב או פנה לתמיכה.',
                        showConfirm: true,
                        showCancel: false
                    });
                }
                console.error('Error in fetchSurveyData:', error);
                throw error;
            }
        };
        // Fix 2: Add form validation
        const validateForm = (form) => {
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            let firstErrorElement = null;

            // Reset any existing error states
            form.querySelectorAll('.error').forEach(element => {
                element.classList.remove('error');
            });

            requiredFields.forEach(field => {
                if (field.type === 'radio') {
                    const groupName = field.name;
                    const checkedRadio = form.querySelector(`input[name="${groupName}"]:checked`);
                    if (!checkedRadio) {
                        isValid = false;
                        const questionCard = field.closest('.question-card');
                        if (questionCard) {
                            questionCard.classList.add('error');
                            if (!firstErrorElement) {
                                firstErrorElement = questionCard;
                            }
                        }
                    }
                } else if (!field.value.trim()) {
                    isValid = false;
                    const questionCard = field.closest('.question-card');
                    if (questionCard) {
                        questionCard.classList.add('error');
                        if (!firstErrorElement) {
                            firstErrorElement = questionCard;
                        }
                    }
                }
            });

            // Only scroll to the first error
            if (firstErrorElement) {
                firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    document.querySelectorAll('.error').forEach(element => {
                        element.classList.remove('error');
                    });
                }, 3000);
            }

            // Show/hide download button based on validation
            const downloadBtn = document.getElementById('downloadExcelBtn');
            if (downloadBtn) {
                downloadBtn.style.display = isValid ? 'inline' : 'none';
            }

            return isValid;
        };



        const disableForm = (form) => {
            form.querySelectorAll('input, textarea').forEach(element => {
                element.disabled = true;
            });
            form.classList.add('form-submitted');
        };
        const showCustomPopup = ({
            type = 'info',
            title,
            message,
            showConfirm = false,
            onConfirm = null,
            onCancel = null,
            showCancel = true
        }) => {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';

            // Create popup
            const popup = document.createElement('div');
            popup.className = 'custom-popup';

            // Icon based on type
            const iconDiv = document.createElement('div');
            iconDiv.className = `popup-icon ${type}`;

            let iconSvg = '';
            switch (type) {
                case 'success':
                    iconSvg = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>`;
                    break;
                case 'error':
                    iconSvg = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>`;
                    break;
                case 'warning':
                    iconSvg = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>`;
                    break;
            }

            iconDiv.innerHTML = iconSvg;

            // Create content
            popup.innerHTML = `
        ${iconDiv.outerHTML}
        <h3 class="popup-title">${title}</h3>
        <p class="popup-message">${message}</p>
        <div class="popup-buttons">
            ${showConfirm ? `
                <button class="popup-button primary">${showCancel ? 'אישור' : 'אוקיי'}</button>
                ${showCancel ? '<button class="popup-button secondary">ביטול</button>' : ''}
            ` : `
                <button class="popup-button primary">סגור</button>
            `}
        </div>
    `;

            // Add event listeners
            const buttons = popup.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.classList.contains('primary')) {
                        if (onConfirm) onConfirm();
                    } else {
                        if (onCancel) onCancel();
                    }
                    document.body.removeChild(overlay);
                });
            });

            // Add to document
            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            return popup;
        };
        // Initialization
        const initializeSurvey = async () => {
            try {
                const surveyParams = getSurveyParams();

                let surveyData;
                try {
                    surveyData = await fetchSurveyData(surveyParams);

                    if (surveyData) {
                        // Populate employee info
                        populateEmployeeInfo(surveyData);

                        // Check if survey is already filled
                        const isFilledOut = isSurveyAlreadyFilled(surveyData, surveyParams);


                        if (isFilledOut) {
                            showSurveyFilledMessage(surveyParams.position);
                            return; // Exit early if survey is already filled
                        }

                        // Continue with normal survey loading if not filled
                        initGuidancePopup();
                        loadSurvey(surveyParams, surveyData.managment);
                        addDownloadButton();

                        const form = document.getElementById('evaluationForm');

                        form.addEventListener('change', (e) => {
                            updateProgress();
                            validateForm(form);
                            const questionCard = e.target.closest('.question-card');
                            if (questionCard && questionCard.classList.contains('error')) {
                                questionCard.classList.remove('error');
                            }
                        });

                        form.addEventListener('submit', handleSubmit);
                    }
                } catch (error) {
                    console.error('Failed to fetch survey data:', error);
                    showErrorMessage('אירעה שגיאה בטעינת נתוני הסקר');
                }
            } catch (error) {
                console.error('Error in initializeSurvey:', error);
                showErrorMessage('אירעה שגיאה בטעינת הטופס. אנא נסה לטעון מחדש את העמוד.');
            }
        };
        function initGuidancePopup() {
            const popup = document.querySelector('.guidance-popup');
            const slides = document.querySelectorAll('.guidance-slide');
            const dots = document.querySelectorAll('.dot');
            const prevBtn = document.querySelector('.nav-button.prev');
            const nextBtn = document.querySelector('.nav-button.next');
            let currentSlide = 0;

            function showSlide(index) {
                slides.forEach(slide => {
                    slide.classList.remove('active');
                    slide.style.opacity = '0';
                });
                dots.forEach(dot => dot.classList.remove('active'));

                slides[index].classList.add('active');
                slides[index].style.opacity = '1';
                dots[index].classList.add('active');

                // Update button states
                prevBtn.disabled = index === 0;
                if (index === slides.length - 1) {
                    nextBtn.textContent = 'התחל';
                } else {
                    nextBtn.textContent = 'הבא';
                }
            }

            function nextSlide() {
                if (currentSlide === slides.length - 1) {
                    popup.classList.remove('active');
                    return;
                }
                currentSlide = Math.min(currentSlide + 1, slides.length - 1);
                showSlide(currentSlide);
            }

            function prevSlide() {
                currentSlide = Math.max(currentSlide - 1, 0);
                showSlide(currentSlide);
            }

            // Event listeners
            prevBtn.addEventListener('click', prevSlide);
            nextBtn.addEventListener('click', nextSlide);

            dots.forEach((dot, index) => {
                dot.addEventListener('click', () => {
                    currentSlide = index;
                    showSlide(currentSlide);
                });
            });

            // Initialize
            popup.classList.add('active');
            showSlide(0);
        }

        // Start everything when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingOverlay = document.getElementById('loadingOverlay');

            try {
                // Show loading state
                loadingOverlay.style.display = 'flex';

                // Initialize survey
                await initializeSurvey();

                // Hide skeleton and show real content
                document.body.classList.remove('skeleton-content');
                document.body.classList.add('content-loaded');

                // Hide loading overlay with fade effect
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300);

            } catch (error) {
                console.error('Error initializing survey:', error);
                showCustomPopup({
                    type: 'error',
                    title: 'שגיאה',
                    message: 'אירעה שגיאה בטעינת הטופס. אנא נסה שוב מאוחר יותר.'
                });
            }
        });
    </script>
    <div id="guidancePopup" class="guidance-popup">
        <div class="guidance-overlay"></div>
        <div class="guidance-content">
            <div class="guidance-slides">
                <!-- Slide 1 -->
                <div class="guidance-slide" data-slide="0">
                    <div class="slide-content">
                        <img src="101.jpg" alt="משוב הדדי" />
                        <h2>ברוכים הבאים למשוב ההדדי</h2>
                        <p>תהליך המשוב ההדדי מתחיל כאשר העובד והמנהל ממלאים באופן עצמאי את אותו טופס הערכה עבור העובד.
                            כל אחד עונה על השאלות מנקודת מבטו, מבלי לראות את תשובות הצד השני.</p>
                    </div>
                </div>
                <!-- Slide 2 -->
                <div class="guidance-slide" data-slide="1">
                    <div class="slide-content">
                        <img src="102.jpg" alt="מבנה המשוב" />
                        <h2>מילוי המשוב</h2>
                        <p>המשוב מחולק לקטגוריות שונות כמו ידע מקצועי, מיומנויות עבודה וגישה. בכל קטגוריה תתבקשו לדרג
                            היבטים שונים בסולם של 1-4, ולהוסיף הערות מילוליות בשאלות הפתוחות.</p>
                    </div>
                </div>
                <!-- Slide 3 -->
                <div class="guidance-slide" data-slide="2">
                    <div class="slide-content">
                        <img src="103.jpg" alt="פגישת משוב" />
                        <h2>פגישת המשוב</h2>
                        <p>לאחר מילוי הטפסים, המנהל יזמן פגישה אישית עם העובד. בפגישה זו יעברו יחד על התשובות של שניהם,
                            ידונו בנקודות השונות, ויגבשו תובנות ויעדים להמשך.</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <div class="guidance-navigation">
                <button class="nav-button prev" disabled>הקודם</button>
                <div class="slide-dots">
                    <span class="dot active" data-slide="0"></span>
                    <span class="dot" data-slide="1"></span>
                    <span class="dot" data-slide="2"></span>
                </div>
                <button class="nav-button next">הבא</button>
            </div>
        </div>
    </div>
</body>

</html>